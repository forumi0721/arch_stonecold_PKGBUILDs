# Maintainer: StoneCold <forumi0721[at]gmail[dot]com>

_gitname="webvirtcloud"
pkgname=("${_gitname}-venv-git")
pkgver=20160508.188.4ce76f5
pkgrel=1
pkgdesc="WebVirtCloud is virtualization web interface for admins and users"
arch=("x86_64")
url="https://github.com/retspen/webvirtcloud"
license=("Apache")
depends=("libvirt" "qemu" "dnsmasq" "bridge-utils" "ebtables" "dmidecode" "python2" "supervisor")
makedepends=("git" "python2-pip")
provides=("webvirtcloud" "webvirtcloud-git")
conflicts=("webvirtcloud" "webvirtcloud-git" "webvirtmgr" "webvirtmgr-git")
options=("!strip" "!emptydirs")
install="webvirtcloud-git.install"
source=("${_gitname}::git+https://github.com/retspen/webvirtcloud.git"
        "webvirtcloud.ini"
        "webvirtcloud-staticroot.patch"
        "webvirtcloud.nginx.conf.sample")
md5sums=("SKIP"
         "c538358d423b00e158418cbdede45d40"
         "f0b40e21fd861269b41806857bd18d7f"
         "4572258a85dcb0ef1010d717e48d0431")

pkgver() {
	cd "${srcdir}/${_gitname}"
	echo "$(git log -1 --format="%cd" --date=short | sed "s/-//g").$(git rev-list --count HEAD).$(git rev-parse --short HEAD)"
}

package() {
	install -dm0755 "${pkgdir}/usr/lib/webvirtcloud"
	cp -r "${srcdir}/webvirtcloud" "${pkgdir}/usr/lib"
	rm -rf "${pkgdir}/usr/lib/webvirtcloud/.git"
	
	cd "${pkgdir}/usr/lib/webvirtcloud"

	patch -p1 < "${srcdir}/webvirtcloud-staticroot.patch"
	sed -i "s/libvirt-python==1.3.2/libvirt-python==1.3.3/g" "conf/requirements.txt"
	
	virtualenv2 venv
	virtualenv2 venv --relocatable
	source venv/bin/activate

	pip install -r "conf/requirements.txt" --no-compile

	virtualenv2 venv --relocatable

	sed -i "s@/mnt/HDD/repo/Workspace/ArchLinux/arch_stonecold_PKGBUILDs/webvirtcloud-git/pkg/webvirtcloud-git/usr/lib/webvirtcloud/venv@/usr/lib/webvirtcloud/venv@g" venv/bin/activate.fish
	sed -i "s@/mnt/HDD/repo/Workspace/ArchLinux/arch_stonecold_PKGBUILDs/webvirtcloud-git/pkg/webvirtcloud-git/usr/lib/webvirtcloud/venv@/usr/lib/webvirtcloud/venv@g" venv/bin/activate
	sed -i "s@/mnt/HDD/repo/Workspace/ArchLinux/arch_stonecold_PKGBUILDs/webvirtcloud-git/pkg/webvirtcloud-git/usr/lib/webvirtcloud/venv@/usr/lib/webvirtcloud/venv@g" venv/bin/activate.csh
	
	install -dm0755 "${pkgdir}/etc/supervisor.d"
	install -Dm0644 "${srcdir}/webvirtcloud.ini" "${pkgdir}/etc/supervisor.d/webvirtcloud.ini"
	install -dm0755 "${pkgdir}/etc/nginx/conf.d"
	install -Dm0644 "${srcdir}/webvirtcloud.nginx.conf.sample" "${pkgdir}/etc/nginx/conf.d/webvirtcloud.nginx.conf.sample"
}
